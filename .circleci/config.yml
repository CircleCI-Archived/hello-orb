version: 2.1

orbs:
  orb-utils:
    orbs:
      cli: circleci/circleci-cli@volatile
    jobs:
      pack-and-validate-orb:
        description: "Pack the contents of an orb for publishing and validate the orb is well-formed."
        parameters:
          path:
            description: "The root of where the code for the orb lives relative to the root of the repo."
            type: string
          workspace-path:
            description: "When provided, save the contents of the orb into the workspace at the given path. Empty string (also the default value) is a no-op."
            type: string
            default: ""
          artifact-path:
            description: "When provided, save the contents of the orb as an artifact at the path specified. Empty string (also the default value) is a no-op."
            type: string
            default: ""
        executor: cli/default
        steps:
          - checkout
          - run:
              name: "Pack << parameters.path >> and validate it's a well-formed orb."
              command: circleci config pack << parameters.path >> | circleci orb validate -
          - when:
              condition: << parameters.workspace-path >>
              steps:
                - run:
                    name: Save the packed orb to `<< parameters.workspace-path >>`
                    # TODO: this is more fragile than is ideal
                    # TODO: it's a bummer we're packing again, but we don't yet have a way to cleanly assume shared state across commands within an orb.
                    command: |
                      tmpfile=$(mktemp orb.XXXX)
                      circleci config pack << parameters.path >> >> $tmpfile
                      mkdir -p << parameters.workspace-path >>
                      mv $tmpfile << parameters.workspace-path >>
                - persist_to_workspace:
                    name: "putting the packed orb into `<< parameters.workspace-path >>` because that value was passed as `parameters.workspace-path`."
                    root: .
                    paths:
                      - << parameters.workspace-path >>
          - when:
              condition: << parameters.artifact-path >>
              steps:
                - run:
                    name: Save the packed orb to `<< parameters.artifact-path >>`
                    # TODO: This is duplicated from above
                    command: |
                      tmpfile=$(mktemp orb.XXXX)
                      circleci config pack << parameters.path >> >> $tmpfile
                      mkdir -p << parameters.artifact-path >>
                      mv $tmpfile << parameters.artifact-path >>
                - store_artifacts:
                    name: "Storing the artifact to << parameters.artifact-path >>"
                    path: << parameters.artifact-path >>
                    destination: orb.yml 

workflows:
  btd:
    jobs:
      - orb-utils/pack-and-validate-orb:
          path: ./src
          workspace-path: orb-packed/
          artifact-path: orb-packed/






