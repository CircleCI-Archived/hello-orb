version: 2.1

orbs:
  orb-utils:
    orbs:
      cli: circleci/circleci-cli@volatile
    jobs:
      pack-and-validate-orb:
        description: "Pack the contents of an orb for publishing and validate the orb is well-formed."
        parameters:
          path:
            description: "The root of where the code for the orb lives relative to the root of the repo."
            type: string
          workspace-path:
            description: "When provided, save the contents of the orb into the workspace at the given path. Empty string (also the default value) is a no-op."
            type: string
            default: ""
          artifact-path:
            description: "When provided, save the contents of the orb as an artifact at the path specified. Empty string (also the default value) is a no-op."
            type: string
            default: ""
        executor: cli/default
        steps:
          - run:
              name: "Starting the job: pack-and-validate-orb on the directory << parameters.path >>"
              command: |
                echo: "parameters.workspace-path passed as: '<< parameters.workspace-path >>' (if the string is empty no workspace save will be attempted)"
                echo: "parameters.artifact-path passed as: '<< parameters.artifact-path >>' (if the string is empty no artifact save will be attempted)"
          - checkout
          - run:
              name: "Pack << parameters.path >>"
               # TODO: this is more fragile than is ideal
               # TODO: this feels like a hack or a missing feature to have a small dose of shared state across the job that can be mutated at runtime
              command: |
                tmpfile=$(mktemp orb.XXXX.yml)
                circleci config pack << parameters.path >> >> $tmpfile
                'export PACK_AND_VALIDATE_ORB_TEMPFILE="$tmpfile"' >> $BASH_ENV
          - run: 
              name: "Validate whether this is a well-formed orb."
              command: circleci orb validate $PACK_AND_VALIDATE_ORB_FILE
          - when:
              condition: << parameters.workspace-path >>
              steps:
                - run:
                    name: Save the packed orb to `<< parameters.workspace-path >>`
                    command: |
                      mkdir -p << parameters.workspace-path >>
                      cp $PACK_AND_VALIDATE_ORB_FILE << parameters.workspace-path >>
                - persist_to_workspace:
                    name: "putting the packed orb into `<< parameters.workspace-path >>` because that value was passed as `parameters.workspace-path`."
                    root: .
                    paths:
                      - << parameters.workspace-path >>
          - when:
              condition: << parameters.artifact-path >>
              steps:
                - run:
                    name: Save the packed orb to `<< parameters.artifact-path >>`
                    # TODO: This is duplicated from above
                    command: |
                      mkdir -p << parameters.artifact-path >>
                      cp $PACK_AND_VALIDATE_ORB_FILE << parameters.artifact-path >>
                - store_artifacts:
                    name: "Storing the artifact to << parameters.artifact-path >>"
                    path: << parameters.artifact-path >>
                    destination: orb

workflows:
  btd:
    jobs:
      - orb-utils/pack-and-validate-orb:
          path: ./src
          workspace-path: orb-packed/
          artifact-path: orb-packed/






